# Image generation with diffusion models

Created by: Cristiano McDonaldo

## Contributing

- Füstös Gergely
- Györfi Bence

## Project Overview

This project implements unconditional diffusion models, specifically DDPM (Denoising Diffusion Probabilistic Model) and DDIM (Denoising Diffusion Implicit Model), to generate realistic images. The models are evaluated on two datasets: CelebA (a large-scale celebrity face dataset) and Flowers102 (a dataset containing images of 102 flower categories).

## Data Acquisition

The datasets used in this project are:

- CelebA Dataset: A large-scale face attributes dataset with celebrity images. Downloaded from CelebA dataset page.

- Flowers102 Dataset: A dataset containing 102 flower categories. Downloaded from Flowers102 dataset page.

### Main Steps to reach datasets

    1 Login into your Kaggle account
    2 Get into your account settings page
    3 Click on Create a new API token
    4 This will prompt you to download the .json file into your system. Save the file, and copy it to the main directory. (Exactly where Dockerfile is located)

# How to Start the Application

Open a terminal in the project root directory. To start the application, follow these steps:

### 1. Build the Docker Image

Before running the application, you need to build the Docker image:

```
docker-compose build
```

### 2. Grant Execute Permission to Scripts

If you are using the run and stop scripts, ensure they are executable by running:

```
chmod +x run.sh
chmod +x stop.sh
```

This command gives the necessary permissions for the scripts to run.

### 3. Run the Application

To start the application, use the run.sh script.

Run the gradio interface at [localhost:7860](http://localhost:7860):

```
./run.sh
```

Train the models:

```
./run.sh --train-flowers
./run.sh --train-celebs
```

Generate flower images:

```
./run.sh --generate-flowers            # Use best model
./run.sh --generate-flowers --latest   # Use latest model instead of best
./run.sh --generate-celebs             # Use best model
./run.sh --generate-celebs --latest    # Use latest model instead of best
```

### 4. Stop the Application

To stop the application, use the stop.sh script:

```
./stop.sh
```

This will stop the running Docker container.

### 5. Remove the Container (Optional)

If you need to completely stop and remove the container, you can use:

```
docker-compose down
```

This will remove the container and associated resources.

# File Functions

### `images/`
Folder for images generated by the project.
- **`celeba/`**: Sample images generated by the celeba model. This is a connected volume of the docker, the interface shows images from here, and generated images are saved here.
- **`flowers/`**: Sample images generated by the flowers model. This is a connected volume of the docker, the interface shows images from here, and generated images are saved here.
- **`results/`**: Larger sets of images.
   - **`generated_celeb_vae_images/`**: Images generated from the CelebA dataset using VAE.
   - **`generated_ddpm_celeb_images/`**: Images generated from the CelebA dataset using DDPM.
   - **`generated_flower_ddpm_images/`**: Images generated from the Flowers dataset using DDPM.
   - **`generated_flower_vae_images/`**: Images generated from the Flowers dataset using VAE.

### `project/`
The project root directory containing datasets, models, code files, and notebooks.
- **`models/`**: Saved models and modeling-related classes.
  - **`celeba/`**: CelebA models (*_best denotes the DDPM model).
  - **`flowers/`**: Flowers models (*_best denotes the DDPM model).
- **`notebooks/`**: Jupyter notebooks for project visualization, training, analysis, and evaluation.
- **`src/`**: Source code for handling models and datasets.
  - **`dataset_acquisition/`**: Code for downloading and managing datasets.
  - **`data_preparation/`**: Code for preparing data.
  - **`model/`**: Code for defining and managing models, including helper classes for DDPM models.
  - **`train/`**: Code for training models.
- **`train/`**: Configuration files for training.
  - **`interface.py`**: A Gradio-based visual interface enabling step-by-step image generation from CelebA and Flowers datasets and displaying generated images in a gallery. The interface updates results in real-time based on user interactions.
  - **`main.py`**: The main execution script managing various application functionalities, such as data preparation, training DDPM models (on Flowers and CelebA datasets), evaluation, and image generation. It provides options to view generated images through a Gradio interface or train and evaluate models via command-line arguments.

### Additional files in the root directory
- **`.gitignore`**: Lists files ignored by Git.
- **`docker-compose.yml`**: Configuration for starting the Docker container.
- **`Dockerfile`**: File for defining the Docker container environment.
- **`evaluation_criteria.md`**: Documentation for evaluating diffusion models.
- **`kaggle.json`**: API key for downloading Kaggle datasets.
- **`README.md`**: Project overview and documentation.
- **`requirements.txt`**: File containing Python dependencies.
- **`run.sh`**: Script to start the application.
- **`stop.sh`**: Script to stop the application.
- **`Summary_Of_Semester_Work.pdf`**: Summary document of the semester work.

## Related Works

### Research Articles and Blogs
1. Vaibhav Singh. *An In-Depth Guide to Denoising Diffusion Probabilistic Models DDPM – Theory to Implementation* (2023).  
   [LearnOpenCV](https://learnopencv.com/denoising-diffusion-probabilistic-models/)

2. Niels Rogge et al. *The Annotated Diffusion Model*.  
   [Hugging Face Blog](https://huggingface.co/blog/annotated-diffusion)

---

### GitHub Repositories
1. Hugging Face. *Diffusers Library*.  
   [https://github.com/huggingface/diffusers](https://github.com/huggingface/diffusers)

2. Mallick, S. *Guide to Training DDPMs from Scratch: Generating Flowers Using DDPMs*.  
   [LearnOpenCV GitHub Repository](https://github.com/spmallick/learnopencv/blob/master/Guide-to-training-DDPMs-from-Scratch/Generating_flowers_using_DDPMs.ipynb)

3. LearnOpenCV. *Denoising Diffusion Probabilistic Models*.  
   [https://learnopencv.com/denoising-diffusion-probabilistic-models/#What-Are-Diffusion-Probabilistic-Models](https://learnopencv.com/denoising-diffusion-probabilistic-models/#What-Are-Diffusion-Probabilistic-Models)

4. Keras Documentation. *Denoising Diffusion Implicit Models (DDIM)*.  
   [https://keras.io/examples/generative/ddim/](https://keras.io/examples/generative/ddim/)
